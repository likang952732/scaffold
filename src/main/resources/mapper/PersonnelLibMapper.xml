<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wwinfo.mapper.PersonnelLibMapper">

    <sql id="baseSql">
       pl.id,
       pl.orgID,
       pl.full_name,
       pl.job_no,
       pl.phone,
       pl.status,
       pl.remark,
       pl.create_time,
       pl.update_time
    </sql>

    <insert id="batchAdd" parameterType="list">
        insert into personnel_lib
        (orgID,
         full_name,
         job_no,
         phone,
         status,
         remark)
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (
             #{item.orgID},
            #{item.age},
            #{item.sex},
            #{item.createdTime}
            )
        </foreach>
    </insert>

    <select id="listPage" resultType="com.wwinfo.pojo.res.PersonnelLibRes">
      <!--  select
           <include refid="baseSql" />,
           org.orgName
        from personnel_lib pl
        left join organize org ON pl.orgID = org.orgID
        where 1 = 1
        <if test="query.orgID != null">
            and pl.orgID = #{query.orgID }
        </if>
        <if test="query.fullName != null and query.fullName != ''">
            and pl.full_name LIKE CONCAT('%',#{query.fullName},'%')
        </if>
        <if test="query.phone != null and query.phone != ''">
            and pl.phone = #{query.phone}
        </if>
        AND pl.status = 0
        order by pl.create_time desc-->
        select
            <include refid="baseSql" />,
            T.orgName
        from
        (
        SELECT
        au.orgID,au.orgName
        FROM
        (
        SELECT
        *
        FROM
        organize
        WHERE
        upOrgID IS NOT NULL
        ) au,
        (SELECT @pid := #{query.orgID}) pd
        WHERE
        FIND_IN_SET(upOrgID, @pid) > 0
        AND @pid := concat(@pid, ',', orgID)
        UNION
        SELECT
        orgID, orgName
        FROM
        organize
        WHERE
        orgID = #{query.orgID}
        ) T
        join personnel_lib pl ON pl.orgID = T.orgID
        where 1 = 1
        <if test="query.fullName != null and query.fullName != ''">
            and pl.full_name LIKE CONCAT('%',#{query.fullName},'%')
        </if>
        <if test="query.phone != null and query.phone != ''">
            and pl.phone = #{query.phone}
        </if>
        <if test="query.canorgID != null">
            and pl.orgID = #{query.canorgID}
        </if>
        AND pl.status = 0
        order by pl.create_time desc
    </select>

    <select id="getList" resultType="com.wwinfo.pojo.res.PersonnelLibRes" parameterType="java.lang.Long">
        select
            <include refid="baseSql" />,
        org.orgName
        from personnel_lib pl
        left join organize org ON pl.orgID = org.orgID
        where 1 = 1
        <if test="orgID != null">
            and pl.orgID = #{orgID }
        </if>
        AND pl.status = 0
        order by pl.create_time desc
    </select>
</mapper>
