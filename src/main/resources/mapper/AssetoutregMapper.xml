<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wwinfo.mapper.AssetoutregMapper">

    <sql id = "baseSql">
        asout.ID,
        asout.assetID,
        asout.regTime,
        asout.outType,
        asout.lendStart,
        asout.lendEnd,
        asout.address,
        asout.usages,
        asout.borrowMan,
        asout.borrowOrg,
        asout.estimateTime,
        asout.remark,
        asout.outTime,
        asout.inTime,
        asout.status,
        asout.returnTime
    </sql>

    <insert id="addBatch" parameterType="list">
        insert into assetOutReg
        (
        assetID,
        regTime,
        outType,
        lendStart,
        lendEnd,
        address,
        usages,
        borrowMan,
        borrowOrg,
        estimateTime,
        remark
        )
        values
        <foreach collection="addVOList" item="item" index="index" separator=",">
            (
            #{item.assetID},
            #{item.regTime},
            #{item.outType},
            #{item.lendStart},
            #{item.lendEnd},
            #{item.address},
            #{item.usages},
            #{item.borrowMan},
            #{item.borrowOrg},
            #{item.estimateTime},
            #{item.remark}
            )
        </foreach>
    </insert>

    <select id="page" parameterType="com.wwinfo.pojo.query.AssetoutregQuery" resultType="com.wwinfo.pojo.res.AssetoutregRes">
        select
            <include refid="baseSql" />,
            ast.name AS "assetName",
            T.orgName
        FROM
        (
        SELECT
        au.orgID,au.orgName
        FROM
        (
        SELECT
        *
        FROM
        organize
        WHERE
        upOrgID IS NOT NULL
        ) au,
        (SELECT @pid := #{query.orgID}) pd
        WHERE
        FIND_IN_SET(upOrgID, @pid) > 0
        AND @pid := concat(@pid, ',', orgID)
        UNION
        SELECT
        orgID, orgName
        FROM
        organize
        WHERE
        orgID = #{query.orgID}
        ) T
        JOIN asset ast ON T.orgID = ast.orgID
        JOIN assetOutReg asout ON asout.assetID = ast.ID
        where 1 = 1
        <if test="query.assetID != null">
            AND asout.assetID = #{query.assetID}
        </if>
        <if test="query.outType != null">
            AND asout.outType = #{query.outType}
        </if>
        <if test="query.status != null">
            AND asout.status = #{query.status}
        </if>
        <if test="query.orgID != null">
            AND ast.orgID = #{query.orgID}
        </if>
        order by asout.regTime desc
    </select>

    <select id="page2" parameterType="com.wwinfo.pojo.query.AssetoutregQuery" resultType="com.wwinfo.pojo.res.AssetoutregRes">
        select
        <include refid="baseSql" />,
        ast.name AS "assetName",
        T.orgName
        FROM
        (
        SELECT
        au.orgID,au.orgName
        FROM
        (
        SELECT
        *
        FROM
        organize
        WHERE
        upOrgID IS NOT NULL
        ) au,
        (SELECT @pid := #{query.orgID}) pd
        WHERE
        FIND_IN_SET(upOrgID, @pid) > 0
        AND @pid := concat(@pid, ',', orgID)
        UNION
        SELECT
        orgID, orgName
        FROM
        organize
        WHERE
        orgID = #{query.orgID}
        ) T
        JOIN asset ast ON T.orgID = ast.orgID
        JOIN assetOutReg asout ON asout.assetID = ast.ID
        where 1 = 1
        <if test="query.assetID != null">
            AND asout.assetID = #{query.assetID}
        </if>
        <if test="query.outType != null">
            AND asout.outType = #{query.outType}
        </if>
        AND asout.status in (0,1)
        <if test="query.orgID != null">
            AND ast.orgID = #{query.orgID}
        </if>
        order by asout.regTime desc
    </select>

    <select id="getByAssetID" resultType="com.wwinfo.model.Assetoutreg" parameterType="java.lang.Long">
        SELECT <include refid="baseSql" /> FROM assetOutReg asout WHERE asout.assetID = #{assetID}
    </select>

</mapper>
